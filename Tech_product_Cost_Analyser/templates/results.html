<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Product Cost Estimation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .category-header { background:#f7fafc; font-weight:700; padding:10px; border-radius:6px; margin-top:12px; }
    .item-row { border-bottom:1px solid #eee; }
    .subtotal { text-align:right; font-weight:700; padding:8px 0; }
    .grand-total { text-align:center; font-size:20px; font-weight:800; margin-top:18px; color:#1f2937; }
    .category-title { font-size:16px; color:#0b63d4; font-weight:700; margin-bottom:6px; }
    .no-items { color:#777; font-style:italic; padding:8px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{ product_name | title }} Cost Breakdown</h1>
    <p class="subtitle">
      Analysis for <b>{{ product_name }}</b> in <b>{{ place | title }}</b>
      (Currency: <span class="currency">{{ currency }}</span>)
    </p>

    {% if error %}
      <p class="error-msg">Error fetching data: {{ error }}</p>
    {% endif %}

    {% for cat in categories %}
      <div class="category-block">
        <div class="category-header">
          <div class="category-title">{{ cat['title'] }}</div>
          <div class="category-subtitle">Subtotal: <span class="currency">{{ cat['subtotal'] }} {{ currency }}</span></div>
        </div>

        {% set items = cat['items'] if cat is mapping else [] %}
        {% if items and items | length > 0 %}
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Item</th>
                <th>Specs</th>
                <th>Qty</th>
                <th style="text-align:right">Price ({{ currency }})</th>
                <th style="text-align:right">Line Total ({{ currency }})</th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr class="item-row">
                <td>{{ loop.index }}</td>
                <td>{{ it['name'] if it is mapping else it.name }}</td>
                <td>{{ it['specs'] if it is mapping else it.specs }}</td>
                <td>{{ it['quantity'] if it is mapping else it.quantity }}</td>
                <td style="text-align:right">
                  {{ "%.2f"|format((it['price'] if it is mapping else it.price) | float) }}
                </td>
                <td style="text-align:right">
                  {{
                    "%.2f"|format(
                      ((it['price'] if it is mapping else it.price) | float) *
                      ((it['quantity'] if it is mapping else it.quantity) | float)
                    )
                  }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="no-items">No items listed for this category.</div>
        {% endif %}
      </div>
    {% endfor %}

    <div class="grand-total">
      Grand Total Estimated Cost: <span class="currency">{{ grand_total }} {{ currency }}</span>
    </div>

    <div style="text-align:center; margin-top:16px;">
      <a href="/" class="back-btn">‚Üê Back to Home</a>
    </div>

    <div style="margin-top:18px; font-size:13px; color:#666;">
      {% if raw_model_data %}
      <details>
        <summary>Show raw model JSON (debug)</summary>
        <pre style="max-height:300px; overflow:auto; background:#f6f8fa; padding:10px;">{{ raw_model_data | tojson(indent=2) }}</pre>
      </details>
      {% endif %}
    </div>
  </div>
</body>
</html>